<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Ólíkar áferðir</title>
	</head>
	<body>
        <canvas id="c"  width="800" height="800"></canvas>
		<script src="js/three.js"></script>
        <script src="js/examples/OrbitControls.js"></script>
        <script src="js/examples/dat.gui.min.js"></script>
		<script>
            // Ná í striga
            const canvas = document.querySelector('#c');

            const size = 16;
            const divisions = 15;
            const cellSize = size / divisions;
            var cameraView = { checkbox: true };
            var isShooting = false;

            // Skilgreina sviðsnet
			const scene = new THREE.Scene();
            scene.background = new THREE.Color( 0xeeeeee );
            
            // Skilgreina myndavél og staðsetja hana

			//const camera = new THREE.PerspectiveCamera( 75, canvas.clientWidth/canvas.clientHeight, 0.1, 1000 );
			//camera.position.set(0, 5, 16);
            const camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            camera.position.set(0, 1.5,  12);

            // Bæta við músarstýringu
            const controls = new THREE.OrbitControls( camera, canvas );

            // Skilgreina birtingaraðferð með afbjögun (antialias)
			const renderer = new THREE.WebGLRenderer({canvas, antialias:true});

            // ----------------------Teikna gridið ------------------------------------------
            const gridHelper = new THREE.GridHelper( size, divisions );
            scene.add( gridHelper );

            //-------------------Teikna upp Centipede --------------------------------------
			const ballGeometry = new THREE.SphereGeometry( 0.4, 12, 10 );

            var centipede = new THREE.Object3D();
            //Hausinn
            const headMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000 });
			var head = new THREE.Mesh(ballGeometry, headMaterial);
            head.position.z = -8;
            head.position.y = 0.2;
            centipede.add(head);

            //Líkami
            var position = 0.5;
            for(var i = 0; i < 5; i++){
                const standardMaterial = new THREE.MeshStandardMaterial( { color: 0x038C3E } );
			    const body = new THREE.Mesh( ballGeometry, standardMaterial );
                body.position.x -= (i + 1) * 0.5;
                body.position.z = -8;
                body.position.y = 0.2;
                centipede.add(body);
                position += 0.5;
            }
            scene.add(centipede);

            //------------------ Teikna sveppina ---------------------------------------------

            const mushrooms = [];
            const mushroomsStilkur = [];
            const stilkurGemotry = new THREE.CylinderGeometry(0.1, 0.2, 0.4, 10);
            const stilkurMaterial = new THREE.MeshStandardMaterial({color: 0xffffff});

            const hatGemotry = new THREE.ConeGeometry(0.3, 0.2, 16)
            const hatMaterial = new THREE.MeshStandardMaterial({color: 0xEB3650});

            for (let j = -8; j <= 8; j++) {
                var random = Math.random() * 15 - 7.5;
                const stilkurBody = new THREE.Mesh(stilkurGemotry, stilkurMaterial);
                stilkurBody.position.set(random, 0.25, j);
                scene.add(stilkurBody);

                const hatBody = new THREE.Mesh(hatGemotry, hatMaterial);
                hatBody.position.set(random, 0.25+0.2, j);
                scene.add(hatBody)
                mushrooms.push(hatBody);
                mushroomsStilkur.push(stilkurBody);

            }

            const mushroomHits = new Array(mushrooms.length).fill(0);

            //-----------------Álfur-----------------------------------------------------
            function createPart(geometry, material, position, parent, yOffset) {
                const part = new THREE.Mesh(geometry, material);
                part.position.set(position.x, yOffset, position.z);
                parent.add(part);
            }



            const alfur = new THREE.Object3D();
            scene.add(alfur);

            const zPosition = divisions / 2 + 1;

            const leftFootGeometry = new THREE.BoxGeometry(0.6, 0.2, 0.4);
            const leftFootMaterial = new THREE.MeshBasicMaterial({ color: 0x8A65E6 });
            createPart(leftFootGeometry, leftFootMaterial, { x: 0, z: zPosition }, alfur, 0.1);

            const upperBodyGeometry = new THREE.CapsuleGeometry(0.4, 0.1, 1.5, 5);
            const upperBodyMaterial = new THREE.MeshBasicMaterial({ color: 0x638BE1 });
            createPart(upperBodyGeometry, upperBodyMaterial, { x: 0, z: zPosition }, alfur, 0.55);

            const faceAlfurGeometry = new THREE.SphereGeometry(0.3, 24, 24);
            const faceAlfurMaterial = new THREE.MeshBasicMaterial({ color: 0xE0B78D });
            createPart(faceAlfurGeometry, faceAlfurMaterial, { x: 0, z: zPosition }, alfur, 1.35);

            const hatAlfurGeometry = new THREE.ConeGeometry(0.5, 0.5, 10);
            const hatAlfurMaterial = new THREE.MeshStandardMaterial({ color: 0xEB3650 });
            createPart(hatAlfurGeometry, hatAlfurMaterial, { x: 0, z: zPosition }, alfur, 1.8);


            //-------------------- Skot -----------------------------------------
            const bulletGeometry = new THREE.ConeGeometry( 0.4, 0.2, 10 ); 
            const bulletMatieral = new THREE.MeshBasicMaterial( { color: 0x8A65E6 }); 
            const bullet = new THREE.Mesh( bulletGeometry, bulletMatieral );

            let bulletActive = false;
            
            // Skilgreina ljósgjafa og bæta honum í sviðsnetið
            const light = new THREE.DirectionalLight(0xFFFFFF, 1);
            light.position.set(3, 3, 3);
            scene.add(light);

            const gui = new dat.GUI();
            gui.add(cameraView, 'checkbox').onChange(function (value) {
                console.log(value);
            }); 

            function onKeyDown(event) {
                switch (event.keyCode) {
                    case 37: 
                        alfur.position.x -= 0.5;
                        break;
                    case 39: 
                        alfur.position.x += 0.5;
                        break;
                    case 32:
                        shoot();
                        break;
                }
            }

            document.addEventListener('keydown', onKeyDown);

            function shoot(){
                if (!bulletActive) {
                    const vector = new THREE.Vector3(0, 0, -1);
                    bullet.position.set(alfur.position.x, 0.1, divisions/2+0.5);
                    bullet.velocity = vector.multiplyScalar(0.1);
                    scene.add(bullet);
                    bulletActive = true;
                }
            }

            function handleBulletCollision() {
                for (let i = 0; i < mushrooms.length; i++) {
                    if (mushroomHits[i] < 4) {
                        const mushroom = mushrooms[i];
                        const mushroomPosition = mushroom.position;
                        const distance = bullet.position.distanceTo(mushroomPosition);
                        if (distance < 0.5) {
                            mushroomHits[i]++;
                            scene.remove(bullet);
                            bulletActive = false;
                            if (mushroomHits[i] === 4) {
                                scene.remove(mushroom);
                                scene.remove(mushroomsStilkur[i]);
                            }
                            break;
                        } 
                    }
                }
            }

			const animate = function () {
				requestAnimationFrame( animate );

                if (bulletActive) {
                    bullet.position.add(bullet.velocity);
                    handleBulletCollision();
                } 
                if(bullet.position.z < -8){
                    bulletActive = false;
                    scene.remove(bullet);

                }



                if(cameraView.checkbox){
                    camera.position.set(alfur.position.x, 1.5, divisions / 2+0.5);
                } else {
                    camera.position.set(0, 5, 16)
                }

                var direction = 1;
                for(var i = 0; i < centipede.children.length; i++){
                    var bodyPart = centipede.children[i];
                    if (!bodyPart.direction) {
                        bodyPart.direction = 1; 
                    }

                    if (bodyPart.position.x < -size / 2 || bodyPart.position.x > size / 2) {
                        bodyPart.position.z += 0.5;
                        bodyPart.direction *= -1;
                    } else if (bodyPart.position.z < -size / 2 || bodyPart.position.z > size / 2) {
                        bodyPart.position.z += 0.5;
                        bodyPart.direction *= -1;
                    } 
                    bodyPart.position.x += 0.05 * bodyPart.direction;
                }
	

				renderer.render( scene, camera );
			};

            function collission(object ){
                var originPoint = object.position.clone();

                for (var i = 0; i < mushrooms.length; i++) {
                    var mushroom = mushrooms[i];
                    var distance = originPoint.distanceTo(mushroom.hat.position);
                    console.log(mushroom.hat.geometry.interse)

                    if (distance < 0.5) { 
                        console.log(mushroom)
                        scene.remove(object);

                        if (mushroomHitCounts[i] === undefined) {
                            mushroomHitCounts[i] = 1;
                        } else {
                            mushroomHitCounts[i]++;
                        }

                        if (mushroomHitCounts[i] >= 4) {
                            scene.remove(mushroom.hat);
                            scene.remove(mushroom.stilkur);
                            delete mushroomHitCounts[i];
                            console.log(mushroomHitCounts[i]);
                        }
                    }
                }
            }

            function collisionDetection(bullet, mushrooms) {
    const bulletBox = new THREE.Sphere().setFromObject(bullet);

    for (let i = 0; i < mushrooms.length; i++) {
        const mushroom = mushrooms[i];
        const mushroomBox = new THREE.Sphere().setFromPoints(mushroom.hat.geometry.points);

        console.log(bulletBox + " " + mushroomBox);
        if (bulletBox.intersectsBox(mushroomBox)) {
            // Collision detected
            scene.remove(bullet); // Remove the bullet
            scene.remove(mushroom.hat); // Remove the mushroom's hat
            scene.remove(mushroom.stilkur); // Remove the mushroom's stem

            // Keep track of how many times each mushroom has been hit
            const mushroomKey = i.toString();
            if (mushroomHitCounts[mushroomKey]) {
                mushroomHitCounts[mushroomKey]++;
                if (mushroomHitCounts[mushroomKey] >= 3) {
                    // Remove the entire mushroom if hit 3 times
                    mushrooms.splice(i, 1);
                }
            } else {
                mushroomHitCounts[mushroomKey] = 1;
            }
        }
    }
}

			animate();
		</script>
	</body>
</html>