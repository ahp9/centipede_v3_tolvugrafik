<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Ólíkar áferðir</title>
        <link rel="stylesheet" href="./styles.css">
	</head>
	<body>
        <canvas id="c"  width="800" height="800"></canvas>
		<script src="js/three.js"></script>
        <script src="js/examples/OrbitControls.js"></script>
        <script src="js/examples/dat.gui.min.js"></script>
		<script>
            // Ná í striga
            const canvas = document.querySelector('#c');

            const size = 16;
            const divisions = 15;
            var score = 0;

            const mushroomColors = [
                0xFFB6C1,  
                0xAEC6CF,  
                0xC3E4C6,  
                0xE0BBE4
            ];

            var isShooting;
            var cameraView;


            // Skilgreina sviðsnet
			const scene = new THREE.Scene();
            scene.background = new THREE.Color( 0x000000 );
            
            // Skilgreina myndavél og staðsetja hana
            const camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            camera.position.set(0, 1.5,  12);

            // Bæta við músarstýringu
            const controls = new THREE.OrbitControls( camera, canvas );

            // Skilgreina birtingaraðferð með afbjögun (antialias)
			const renderer = new THREE.WebGLRenderer({canvas, antialias:true});

            // ----------------------Teikna gridið ------------------------------------------
            const gridHelper = new THREE.GridHelper( size, divisions );
            scene.add( gridHelper );


            //------------Hlutir--------------
            var mushrooms;
            var mushroomsStilkur ;
            var centipede;
            var alfur;
            var mushroomHits;
            let bulletActive = false;
            var bullet;
            var gui;
            var gameConfig;
            var centipedeAlive;
            var cenitpedeDirection;
            var bodyParts;
            var head;
            createGame();

            //---------------GUI---------------------------------
            gui = new dat.GUI();
            gui.add(cameraView, 'checkbox').onChange(function (value) {
                    console.log(value);
                }); 

                gameConfig = {
                    score: 0,
                };

                gui.add(gameConfig, 'score', 0).name('Score');

            function createGame(){
                mushrooms = new THREE.Object3D();
                mushroomsStilkur = new THREE.Object3D();
                centipede = new THREE.Object3D();
                bodyParts = [];
                alfur = new THREE.Object3D();
                cameraView = { checkbox: true };
                isShooting = false;

                //-------------------Teikna upp Centipede --------------------------------------
			    const ballGeometry = new THREE.SphereGeometry( 0.4, 12, 10 );

                centipede = new THREE.Object3D();
                //Hausinn
                const headMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000 });
                head = new THREE.Mesh(ballGeometry, headMaterial);
                head.position.z = -8;
                head.position.y = 0.2;
                centipede.add(head);
                bodyParts.push(head);

                //Líkami
                var position = 0.5;
                for(var i = 0; i < 5; i++){
                    const standardMaterial = new THREE.MeshStandardMaterial( { color: 0x038C3E } );
                    const body = new THREE.Mesh( ballGeometry, standardMaterial );
                    body.position.x -= (i + 1) * 0.5;
                    body.position.z = -8;
                    body.position.y = 0.2;
                    centipede.add(body);
                    bodyParts.push(body);
                    position += 0.5;
                }
                scene.add(centipede);

                cenitpedeDirection = new THREE.Vector3(0.5, 0, 0);

                centipedeAlive = true;

                //------------------ Teikna sveppina ---------------------------------------------
                createMushroom(true, null);

                //-----------------Álfur-----------------------------------------------------

                function createPart(geometry, material, position, parent, yOffset) {
                    const part = new THREE.Mesh(geometry, material);
                    part.position.set(position.x, yOffset, position.z);
                    parent.add(part);
                }

                alfur = new THREE.Object3D();
                scene.add(alfur);

                const zPosition = divisions / 2 + 1;

                const leftFootGeometry = new THREE.BoxGeometry(0.6, 0.2, 0.4);
                const leftFootMaterial = new THREE.MeshBasicMaterial({ color: 0x8A65E6 });
                createPart(leftFootGeometry, leftFootMaterial, { x: 0, z: zPosition }, alfur, 0.1);

                const upperBodyGeometry = new THREE.CapsuleGeometry(0.4, 0.1, 1.5, 5);
                const upperBodyMaterial = new THREE.MeshBasicMaterial({ color: 0x638BE1 });
                createPart(upperBodyGeometry, upperBodyMaterial, { x: 0, z: zPosition }, alfur, 0.55);

                const faceAlfurGeometry = new THREE.SphereGeometry(0.3, 24, 24);
                const faceAlfurMaterial = new THREE.MeshBasicMaterial({ color: 0xE0B78D });
                createPart(faceAlfurGeometry, faceAlfurMaterial, { x: 0, z: zPosition }, alfur, 1.35);

                const hatAlfurGeometry = new THREE.ConeGeometry(0.5, 0.5, 10);
                const hatAlfurMaterial = new THREE.MeshStandardMaterial({ color: 0xEB3650 });
                createPart(hatAlfurGeometry, hatAlfurMaterial, { x: 0, z: zPosition }, alfur, 1.8);

                //-------------------- Skot -----------------------------------------
                const bulletGeometry = new THREE.IcosahedronGeometry(0.1, 5);
                const bulletMatieral = new THREE.MeshBasicMaterial( { color: 0xFFFF00 }); 
                bullet = new THREE.Mesh( bulletGeometry, bulletMatieral );

                let bulletActive = false;

                //------------GUI----------------------------------------------------------
            }
            
            function createMushroom(start, bodyPart){
                mushrooms = new THREE.Object3D();
                mushroomsStilkur = new THREE.Object3D();

                const stilkurGemotry = new THREE.CylinderGeometry(0.1, 0.2, 0.4, 10);
                const stilkurMaterial = new THREE.MeshStandardMaterial({color: 0xffffff});

                const hatGemotry = new THREE.ConeGeometry(0.3, 0.2, 16)
                const hatMaterial = new THREE.MeshStandardMaterial({color: 0xEB3650});

                if(start){
                    for (let j = -8; j <= 8; j++) {
                        var random = Math.random() * 15 - 7.5;
                        const stilkurBody = new THREE.Mesh(stilkurGemotry, stilkurMaterial);
                        stilkurBody.position.set(random, 0.25, j-0.5);

                        const hatBody = new THREE.Mesh(hatGemotry, hatMaterial);
                        hatBody.position.set(random, 0.25+0.2, j-0.5);

                        mushrooms.add(hatBody);
                        mushroomsStilkur.add(stilkurBody);
                    }
                } else {
                    const stilkurBody = new THREE.Mesh(stilkurGemotry, stilkurMaterial);
                    stilkurBody.position.set(bodyPart.position.x, 0.25, bodyPart.position.z);

                    const hatBody = new THREE.Mesh(hatGemotry, hatMaterial);
                    hatBody.position.set(bodyPart.position.x, 0.25+0.2, bodyPart.position.z);

                    mushrooms.add(hatBody);
                    mushroomsStilkur.add(stilkurBody);
                }

                scene.add(mushrooms);
                scene.add(mushroomsStilkur);

                mushroomHits = new Array(mushrooms.children.length).fill(0);
            }

            //----------------------Ljós----------------------------------------------------
            const light = new THREE.DirectionalLight(0xFFFFFF, 1);
            light.position.set(3, 3, 3);
            scene.add(light);

            function updateCentipede(){
                var collision = 0;
                var oldP = oldPosition(bodyParts);
                for(var i = 0; i < bodyParts.length; i++){
                    var bodyPart = bodyParts[i];
                    if(bodyPart.material.color.getHex() === 0xff0000){
                        var newBody = [];
                        newBody.push(bodyPart);
                        if(i + 1 < bodyParts.length ){
                            if(bodyParts[i+1].material.color.getHex() !== 0xff0000){
                                for(var j = i+1; j < bodyParts.length; j++){
                                    newBody.push(bodyParts[j]);
                                }
                            }
                        }
                        collision = centipedeMushRoomCollision(bodyPart, newBody);
                        //console.log(collision);
                    }

                    if (!bodyPart.direction) {
                        bodyPart.direction = 1; 
                    } 

                    if(collision > 0){
                        if (i === 0) {
                            bodyPart.position.z += 0.5;
                        }
                    } else if (bodyPart.position.x < -size / 2 || bodyPart.position.x > size / 2) {
                        bodyPart.position.z += 0.5;
                        bodyPart.direction *= -1;
                    } else if (bodyPart.position.z < -size / 2 || bodyPart.position.z > size / 2) {
                        bodyPart.position.z += 0.5;
                        bodyPart.direction *= -1;
                    } 

                    if(bodyPart.material.color.getHex() === 0xff0000){
                        bodyPart.position.x += 0.05 * bodyPart.direction;
                    } else {
                        bodyPart.position.x = oldP[i - 1].x-0.5;
                        bodyPart.position.z = oldP[i - 1].z;
                    }
                }
            }

            function oldPosition(bodyParts){
                var position = [];
                for(let i = 0; i < bodyParts.length; i++){
                    position.push({x:bodyParts[i].position.x, z:bodyParts[i].position.z}) ;
                }
                return position;
            }

            function oldDirections(bodyParts){
                if(!bodyParts[0].direction){
                    return null;
                }
            }

            function onKeyDown(event) {
                switch (event.keyCode) {
                    case 65: 
                        alfur.position.x -= 0.5;
                        break;
                    case 68: 
                        alfur.position.x += 0.5;
                        break;
                    case 32:
                        shoot();
                        break;
                }
            }

            document.addEventListener('keydown', onKeyDown);

            function shoot(){
                if (!bulletActive) {
                    const vector = new THREE.Vector3(0, 0, -1);
                    bullet.position.set(alfur.position.x, 0.1, divisions/2+0.5);
                    bullet.velocity = vector.multiplyScalar(0.2);
                    scene.add(bullet);
                    bulletActive = true;
                }
            }

            function handleBulletCollision() {
                for (let i = 0; i < mushrooms.children.length; i++) {
                    if (mushroomHits[i] < 4) {
                        const mushroom = mushrooms.children[i];
                        const mushroomPosition = mushroom.position;
                        const distance = bullet.position.distanceTo(mushroomPosition);
                        if (distance < 0.5) {
                            mushroomHits[i]++;
                            scene.remove(bullet);
                            bulletActive = false;
         
                            const hatMaterial = new THREE.MeshStandardMaterial({ color: mushroomColors[mushroomHits[i] -1]});
                            mushroom.material = hatMaterial;

                            if (mushroomHits[i] === 4) {
                                updateScore(1);
                                mushrooms.remove(mushroom);
                                mushroomsStilkur.remove(mushroomsStilkur.children[i]);
                            }
                            break;
                        } 
                    }
                }

                for (let i = 0; i < centipede.children.length; i++) {
                    const bodyPart = centipede.children[i];
                    const bodyPartPosition = bodyPart.position;
                    const distance = bullet.position.distanceTo(bodyPartPosition);
                    if (distance < 0.5) {
                        scene.remove(bullet);
                        bulletActive = false;
                        if(centipede.children[i].material.color.getHex() === 0xff0000){
                            updateScore(100);
                        } else {
                            updateScore(10);
                        }

                        if(centipede.children[i+1].material !== undefined && i+1 < bodyParts.length){
                            centipede.children[i+1].material.color.set(0xff0000);
                            centipede.children[i].material.color.set(0xffffff);
                        }
                        centipede.remove(bodyPart);

                        //console.log(bodyParts);
                        createMushroom(false, bodyPart);                     
                        break;
                    } 
                    
                }
            }


            function centipedeMushRoomCollision(headP, bodyParts) {
                for (let i = 0; i < mushrooms.children.length; i++) {
                    const mushroom = mushrooms.children[i];
                    const mushroomPosition = mushroom.position;
                    const distance = headP.position.distanceTo(mushroomPosition);

                    if (distance < 0.8) {
    
                        const directionToMushroom = new THREE.Vector3().copy(mushroomPosition).sub(headP.position).normalize();
                        const newDirectionZ = new THREE.Vector3(0, 0, -1);

                        const newDirectionX = new THREE.Vector3(-0.5, 0, 0);

                        const newHeadPositionZ = new THREE.Vector3().copy(headP.position).add(newDirectionZ);
                        const newHeadPositionX = new THREE.Vector3().copy(headP.position).add(newDirectionX);

                        let canMoveZ = true;
                        let canMoveX = true;

                        for (let i = 0; i < bodyParts.length; i++) {
                            const part = bodyParts[i];
                            const distanceZ = part.position.distanceTo(newHeadPositionZ);
                            const distanceX = part.position.distanceTo(newHeadPositionX);

                            if (distanceZ < 0.4) {
                                canMoveZ = false;
                            }
                            if (distanceX < 0.4) {
                                canMoveX = false;
                            }
                        }

                        if (canMoveZ) {
                            cenitpedeDirection.copy(newDirectionZ);
                        } else if (canMoveX) {
                            cenitpedeDirection.copy(newDirectionX);
                        }
      
                        return true;
                    }
                }
                return false;
            }

            function checkGameResult() {
                if (centipede.children.length === 0) {
                    showGameOverlay('You Win!');
                    centipedeAlive = false;
                } else {
                    for (var i = 0; i < centipede.children.length; i++) {
                        if (centipede.children[i].position.z >= alfur.children[0].position.z +0.5) {
                            showGameOverlay('You Lose!');
                            centipedeAlive = false;
                            break;
                        }
                    }
                }

                
            }

			const animate = function () {
				requestAnimationFrame( animate );

                if (bulletActive) {
                    bullet.position.add(bullet.velocity);
                    handleBulletCollision();
                } 
                if(bullet.position.z < -8){
                    bulletActive = false;
                    scene.remove(bullet);
                }

                if(cameraView.checkbox){
                    camera.position.set(alfur.position.x, 1.5, divisions / 2+0.5);
                } else {
                    camera.position.set(0, 5, 16)
                }

                updateCentipede();
	

				renderer.render( scene, camera );

                if (centipedeAlive) {
                    checkGameResult();
                }
			};

			animate();

            function updateScore(points) {
                score += points;
                gameConfig.score = score;
                gui.updateDisplay();
            }

            function showGameOverlay(message) {
                const gameOverlay = document.getElementById('gameOverlay');
                const gameMessage = document.getElementById('gameMessage');

                gameMessage.textContent = message;
                gameOverlay.style.display = 'flex';
            }

            function hideGameOverlay() {
                const gameOverlay = document.getElementById('gameOverlay');
                gameOverlay.style.display = 'none';
            }

            function restart(){
                scene.remove(centipede);
                scene.remove(mushrooms);
                scene.remove(mushroomsStilkur);
                scene.remove(alfur);
                gui.remove(gui.add(cameraView, 'checkbox').onChange(function (value) {
                    console.log(value);
                }));
                gui.remove(gui.add(gameConfig, 'score', 0).name('Score'))
                console.log(gameConfig.score);
                hideGameOverlay();
                createGame();

                    // Initialize the GUI settings
                cameraView.checkbox = true;
                gameConfig.score = 0;
                gui.add(cameraView, 'checkbox').onChange(function (value) {
                    console.log(value);
                });
                gui.add(gameConfig, 'score', 0).name('Score');
            }

		</script>
        <div id="gameOverlay" style="display: none;">
            <div id="gameMessage">You Win!</div>
            <button id="restartButton" onclick=restart()>Restart</button>
        </div>
        
	</body>
</html>